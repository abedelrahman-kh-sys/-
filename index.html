<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± - Ù…Ø´Ù‡ÙˆØ± Ù„Ù„Ø¨Ù†Ø§Ø¡</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
:root{--bg:#0b1929;--bg2:#132744;--card:rgba(20,36,58,0.92);--border:#1e3654;--accent:#d4a853;--accentG:#ebd08a;--g:#27c96e;--r:#e74c3c;--o:#f0a030;--blue:#3498db;--tw:#e8edf2;--tm:#8ba3be;--td:#4e6d8a}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:linear-gradient(160deg,var(--bg),var(--bg2) 50%,#0e1e35);color:var(--tw);min-height:100vh;direction:rtl}
button{font-family:inherit;cursor:pointer;border:none;transition:all .25s ease}
input,select{font-family:inherit;outline:none;transition:all .2s ease}
input:focus{border-color:var(--accent)!important;box-shadow:0 0 0 3px rgba(212,168,83,.18)}
.page{display:none;min-height:100vh}.page.active{display:block}
.hdr{background:rgba(12,24,44,.96);border-bottom:2px solid var(--accent);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.hdr-t{font-size:1.1rem;font-weight:800}.hdr-s{font-size:.72rem;color:var(--accent);font-weight:600}
.hdr-btns{display:flex;gap:8px;align-items:center}
.btn-back{background:rgba(212,168,83,.12);border:1px solid rgba(212,168,83,.3);border-radius:8px;padding:8px 16px;color:var(--accent);font-weight:700;font-size:.78rem}
.btn-refresh{background:rgba(39,201,110,.12);border:1px solid rgba(39,201,110,.3);border-radius:8px;padding:8px 14px;color:var(--g);font-weight:700;font-size:.76rem}
.ctr{max-width:480px;margin:0 auto;padding:28px 20px}
.ctr-wide{max-width:960px;margin:0 auto;padding:20px 16px}
.avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accentG));display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900;color:#0b1929;box-shadow:0 6px 30px rgba(212,168,83,.3);margin:0 auto 20px}
.avatar-sm{width:72px;height:72px;font-size:1.8rem;margin:0 auto 14px}
.clock-box{text-align:center;padding:14px;background:rgba(15,25,42,.6);border-radius:12px;border:1px solid var(--border);margin-bottom:20px}
.clock-lbl{font-size:.65rem;color:var(--td);letter-spacing:3px;margin-bottom:4px}
.clock-time{font-size:2.2rem;font-weight:900;font-family:'Courier New',monospace;letter-spacing:4px;direction:ltr}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:24px}
.pin-wrap{display:flex;justify-content:center;gap:12px;direction:ltr}
.pin-inp{width:56px;height:64px;text-align:center;font-size:1.6rem;font-weight:800;background:rgba(15,25,42,.8);border:2px solid var(--border);border-radius:14px;color:var(--tw);font-family:'Courier New',monospace}
.pin-inp.filled{background:rgba(212,168,83,.12);border-color:var(--accent)}
.pin-err{margin-top:12px;color:var(--r);font-size:.82rem;font-weight:700;text-align:center}
.btn-big{width:100%;padding:18px;border-radius:14px;font-size:1.15rem;font-weight:800;color:#fff}
.btn-checkin{background:linear-gradient(135deg,var(--g),#20a85a);box-shadow:0 4px 22px rgba(39,201,110,.3)}
.btn-checkout{background:linear-gradient(135deg,var(--r),#c0392b);box-shadow:0 4px 22px rgba(231,76,60,.3)}
.btn-disabled{background:#2a3d52!important;color:#5a6a7a!important;cursor:not-allowed!important;box-shadow:none!important}
.btn-admin{background:linear-gradient(135deg,var(--accent),var(--accentG));color:#0b1929;box-shadow:0 4px 25px rgba(212,168,83,.28)}
.btn-worker{padding:13px 18px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--tw);font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:12px;width:100%}
.btn-worker:hover{border-color:var(--accent);background:rgba(212,168,83,.06)}
.btn-worker .av{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#1a3a5c,#2a5580);display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:800;color:var(--accent);flex-shrink:0}
.proj-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}
.proj-btn{padding:12px 10px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:var(--tm);font-size:.82rem;font-weight:700;text-align:center}
.proj-btn.sel{background:rgba(212,168,83,.15);border-color:var(--accent);color:var(--accent)}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-radius:12px;margin-bottom:12px}
.info-row.green{background:rgba(39,201,110,.08);border:1px solid rgba(39,201,110,.2)}
.info-row.gold{background:rgba(212,168,83,.08);border:1px solid rgba(212,168,83,.2)}
.stats-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.stat-box{border-radius:10px;padding:12px;text-align:center}
.stat-lbl{font-size:.68rem;color:var(--td);margin-bottom:3px}
.stat-val{font-size:.95rem;font-weight:800;font-family:monospace}
.sum-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px}
.sum-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 10px;text-align:center}
.sum-val{font-size:1.4rem;font-weight:900}
.sum-lbl{font-size:.6rem;color:var(--td);font-weight:600}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:18px;overflow-x:auto}
.tab-btn{padding:10px 16px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--td);font-weight:700;font-size:.78rem;white-space:nowrap}
.tab-btn.active{background:rgba(212,168,83,.12);border-bottom-color:var(--accent);color:var(--accent)}
.tbl-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:22px}
.tbl-head{background:linear-gradient(135deg,#1a3a5c,#2a5580);padding:12px 18px;border-bottom:2px solid var(--accent)}
.tbl-head h3{color:var(--accent);font-size:.9rem;font-weight:700;margin:0}
table{width:100%;border-collapse:collapse}
th{padding:10px 10px;text-align:right;font-size:.66rem;color:var(--td);font-weight:700;border-bottom:1px solid var(--border);white-space:nowrap;background:rgba(26,58,92,.35)}
td{padding:10px 10px;font-size:.8rem;border-bottom:1px solid rgba(30,54,84,.15)}
.mono{font-family:monospace;font-weight:600}
.badge{padding:3px 10px;border-radius:18px;font-size:.7rem;font-weight:700;display:inline-block}
.wtabs{display:flex;border-bottom:1px solid var(--border);overflow-x:auto}
.wtab{padding:10px 16px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--td);font-weight:700;font-size:.8rem;white-space:nowrap}
.wtab.active{background:rgba(212,168,83,.12);border-bottom-color:var(--accent);color:var(--accent)}
.manage-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:18px}
.manage-card h3{color:var(--accent);font-size:.9rem;font-weight:700;margin-bottom:16px}
.manage-row{display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(15,25,42,.6);border-radius:10px;margin-bottom:8px;flex-wrap:wrap}
.manage-input{padding:10px 14px;background:rgba(15,25,42,.8);border:1px solid var(--border);border-radius:10px;color:var(--tw);font-size:.85rem;width:100%}
.btn-sm{padding:4px 10px;border-radius:6px;font-size:.7rem;font-weight:700}
.btn-add{padding:10px 16px;background:linear-gradient(135deg,var(--g),#20a85a);border-radius:10px;color:#fff;font-weight:700;white-space:nowrap}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:999;padding:20px}
.modal{background:#132744;border:1px solid var(--border);border-radius:16px;padding:24px;width:380px;max-width:100%}
.modal h3{color:var(--accent);font-size:.95rem;font-weight:700;margin-bottom:16px}
.tag-btns{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.tag-btn{padding:6px 14px;background:rgba(15,25,42,.8);border:1px solid var(--border);border-radius:8px;color:var(--tm);font-size:.78rem;font-weight:600}
.tag-btn.sel{background:rgba(212,168,83,.2);border-color:var(--accent);color:var(--accent)}
.toast{background:rgba(39,201,110,.14);border:1px solid rgba(39,201,110,.35);border-radius:12px;padding:12px 18px;margin-bottom:18px;text-align:center;color:var(--g);font-weight:700;font-size:.9rem;animation:fadeUp .3s ease}
.toast-err{background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.3);color:var(--r)}
.loading-spinner{text-align:center;padding:40px;color:var(--td);font-size:1rem}
@keyframes fadeUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
@keyframes shakeX{0%,100%{transform:translateX(0)}20%{transform:translateX(-12px)}40%{transform:translateX(12px)}60%{transform:translateX(-8px)}80%{transform:translateX(8px)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.shake{animation:shakeX .5s ease}.fadeUp{animation:fadeUp .4s ease}.pulse{animation:pulse 2s infinite}
@media(max-width:500px){.sum-grid{grid-template-columns:repeat(2,1fr)}.proj-grid{grid-template-columns:1fr}}
::-webkit-scrollbar{height:4px;width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
</style>
</head>
<body>

<!-- SITE PASSWORD PAGE -->
<div id="page-lock" class="page active">
  <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
    <div style="width:88px;height:88px;border-radius:20px;background:linear-gradient(135deg,var(--accent),var(--accentG));display:flex;align-items:center;justify-content:center;font-size:1.9rem;font-weight:900;color:#0b1929;box-shadow:0 8px 35px rgba(212,168,83,.28);margin-bottom:18px">Ù…Ø´</div>
    <h1 style="font-size:1.5rem;font-weight:800;margin-bottom:3px">Ù…Ø´Ù‡ÙˆØ± Ù„Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø©</h1>
    <p style="color:var(--accent);font-size:.82rem;font-weight:600;margin-bottom:6px">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</p>
    <p style="color:var(--td);font-size:.75rem;margin-bottom:32px">ğŸ”’ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</p>
    <div class="card" style="border-radius:18px;padding:32px 24px;width:340px;max-width:100%;text-align:center">
      <div style="font-size:1.4rem;margin-bottom:16px">ğŸ”‘</div>
      <div style="font-size:.8rem;color:var(--tm);margin-bottom:16px;font-weight:600">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¯Ø®ÙˆÙ„</div>
      <input type="password" id="site-pass" class="manage-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="text-align:center;font-size:1.1rem;margin-bottom:14px;direction:ltr" onkeydown="if(event.key==='Enter')checkSitePass()">
      <button class="btn-big btn-admin" style="font-size:1rem" onclick="checkSitePass()">ğŸ”“ Ø¯Ø®ÙˆÙ„</button>
      <div id="site-pass-err" style="display:none;margin-top:12px;color:var(--r);font-size:.82rem;font-weight:700"></div>
    </div>
  </div>
</div>

<!-- HOME PAGE -->
<div id="page-home" class="page">
  <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
    <div style="width:88px;height:88px;border-radius:20px;background:linear-gradient(135deg,var(--accent),var(--accentG));display:flex;align-items:center;justify-content:center;font-size:1.9rem;font-weight:900;color:#0b1929;box-shadow:0 8px 35px rgba(212,168,83,.28);margin-bottom:18px">Ù…Ø´</div>
    <h1 style="font-size:1.5rem;font-weight:800;margin-bottom:3px">Ù…Ø´Ù‡ÙˆØ± Ù„Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø©</h1>
    <p style="color:var(--accent);font-size:.82rem;font-weight:600;margin-bottom:32px">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</p>
    <button class="btn-big btn-admin" style="width:300px;max-width:100%;margin-bottom:14px;font-size:1.05rem" onclick="showPage('admin-pin')">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ù…Ø¯ÙŠØ±)</button>
    <div style="color:var(--td);font-size:.78rem;margin-bottom:14px;font-weight:600">â€” ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± â€”</div>
    <div id="home-workers" style="display:flex;flex-direction:column;gap:8px;width:300px;max-width:100%"></div>
  </div>
</div>

<!-- WORKER PIN -->
<div id="page-worker-pin" class="page">
  <div class="hdr"><div><div class="hdr-t">Ù…Ø´Ù‡ÙˆØ± Ù„Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø©</div><div class="hdr-s">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</div></div><div class="hdr-btns"><button class="btn-back" onclick="showPage('home')">â† Ø±Ø¬ÙˆØ¹</button></div></div>
  <div class="ctr" style="padding-top:50px;text-align:center">
    <div class="avatar" id="wp-avatar"></div>
    <h2 style="font-size:1.4rem;font-weight:800;margin-bottom:6px" id="wp-name"></h2>
    <p style="color:var(--td);font-size:.8rem;margin-bottom:36px">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <div class="card" style="border-radius:18px;padding:32px 24px">
      <div style="font-size:1.4rem;margin-bottom:20px">ğŸ”</div>
      <div style="font-size:.8rem;color:var(--tm);margin-bottom:16px;font-weight:600" id="wp-pin-label">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (4 Ø£Ø±Ù‚Ø§Ù…)</div>
      <div class="pin-wrap" id="wp-pin-wrap"></div>
      <div class="pin-err" id="wp-pin-err" style="display:none"></div>
    </div>
  </div>
</div>

<!-- WORKER MAIN -->
<div id="page-worker" class="page">
  <div class="hdr"><div><div class="hdr-t">Ù…Ø´Ù‡ÙˆØ± Ù„Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø©</div><div class="hdr-s">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</div></div><div class="hdr-btns"><button class="btn-back" onclick="workerLogout()">â† Ø±Ø¬ÙˆØ¹</button></div></div>
  <div class="ctr">
    <div style="text-align:center;margin-bottom:24px">
      <div class="avatar avatar-sm" id="w-avatar"></div>
      <h2 style="font-size:1.3rem;font-weight:800;margin:0" id="w-name"></h2>
      <p style="color:var(--td);font-size:.8rem;margin-top:4px" id="w-date"></p>
    </div>
    <div class="clock-box"><div class="clock-lbl">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</div><div class="clock-time" id="w-clock"></div></div>
    <div id="w-toast"></div>
    <div id="w-error"></div>
    <div class="card fadeUp" id="w-content"><div class="loading-spinner">â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
  </div>
</div>

<!-- ADMIN PIN -->
<div id="page-admin-pin" class="page">
  <div class="hdr"><div><div class="hdr-t">Ù…Ø´Ù‡ÙˆØ± Ù„Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø©</div><div class="hdr-s">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</div></div><div class="hdr-btns"><button class="btn-back" onclick="showPage('home')">â† Ø±Ø¬ÙˆØ¹</button></div></div>
  <div class="ctr" style="padding-top:60px;text-align:center">
    <div style="font-size:3rem;margin-bottom:16px">ğŸ“Š</div>
    <h2 style="font-size:1.3rem;font-weight:800;margin-bottom:6px">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <p style="color:var(--td);font-size:.8rem;margin-bottom:36px">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±</p>
    <div class="card" style="border-radius:18px;padding:32px 24px">
      <div class="pin-wrap" id="ap-pin-wrap"></div>
      <div class="pin-err" id="ap-pin-err" style="display:none"></div>
    </div>
  </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="page-admin" class="page">
  <div class="hdr">
    <div><div class="hdr-t">ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¶ÙˆØ±</div><div class="hdr-s" id="admin-sub"></div></div>
    <div class="hdr-btns"><button class="btn-refresh" onclick="adminLoad()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button><button class="btn-back" onclick="showPage('home')">â† Ø±Ø¬ÙˆØ¹</button></div>
  </div>
  <div class="ctr-wide">
    <div class="sum-grid" id="admin-summary"></div>
    <div class="tabs" id="admin-tabs"></div>
    <div id="admin-content"></div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal-bg" style="display:none" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()" id="modal-content"></div>
</div>

<script>
// ============================================================
// FIREBASE INIT
// ============================================================
firebase.initializeApp({
  apiKey: "AIzaSyBkeSf4uv0b3oPAeQWHn8_at8gcMmOwrHM",
  authDomain: "mashour-attendance.firebaseapp.com",
  projectId: "mashour-attendance",
  storageBucket: "mashour-attendance.firebasestorage.app",
  messagingSenderId: "351494537478",
  appId: "1:351494537478:web:c928ac25d154d9110d5e87"
});
const db = firebase.firestore();

// ============================================================
// SITE PASSWORD - ØºÙŠÙ‘Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‡Ù†Ø§
// ============================================================
const SITE_PASSWORD = "mashhour2026";

// ============================================================
// DEFAULT CONFIG
// ============================================================
const DEF = {
  workers:[
    {id:"muath",name:"Ù…Ø¹Ø§Ø°",pin:"1234",active:true},
    {id:"ahmad",name:"Ø£Ø­Ù…Ø¯",pin:"2345",active:true},
    {id:"khaled",name:"Ø®Ø§Ù„Ø¯",pin:"3456",active:true},
    {id:"omar",name:"Ø¹Ù…Ø±",pin:"4567",active:true},
    {id:"sami",name:"Ø³Ø§Ù…ÙŠ",pin:"5678",active:true},
  ],
  projects:[
    {id:"avital6",name:"××‘×™×˜×œ 6",active:true},
    {id:"haftzelet",name:"×—×¤×¦×œ×ª",active:true},
    {id:"hala15",name:'×”×œ"×” 15',active:true},
    {id:"eden",name:"××ª×—× ×¢×“×Ÿ",active:true},
    {id:"un",name:"UN",active:true},
    {id:"office",name:"××©×¨×“ ××—×™× ××©×”×•×¨",active:true},
    {id:"court",name:"×‘×™×ª ××©×¤×˜",active:true},
  ],
  adminPin:"0000",
  companyName:"Ù…Ø´Ù‡ÙˆØ± Ù„Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø©"
};

// ============================================================
// STATE
// ============================================================
let CFG=null, curW=null, curRec=null, selProj=null, wAttempts=0, aTab="today", mWorker=null, clockInt=null;

// ============================================================
// FIREBASE HELPERS
// ============================================================
async function loadCfg(){
  try{const d=await db.collection("config").doc("main").get();if(d.exists)return d.data();} catch(e){console.log("cfg err",e);}
  return null;
}
async function saveCfg(){
  try{await db.collection("config").doc("main").set(CFG);} catch(e){console.log("save cfg err",e);}
}
async function getAtt(wid,date){
  try{const d=await db.collection("attendance").doc(`${wid}_${date}`).get();return d.exists?d.data():null;} catch{return null;}
}
async function setAtt(wid,date,rec){
  try{await db.collection("attendance").doc(`${wid}_${date}`).set(rec);} catch(e){console.log("set att err",e);}
}
async function delAtt(wid,date){
  try{await db.collection("attendance").doc(`${wid}_${date}`).delete();} catch(e){console.log("del err",e);}
}
async function getAllAtt(wid){
  const recs={};
  try{
    const q=await db.collection("attendance").where("workerId","==",wid).get();
    q.forEach(d=>{const r=d.data();recs[r.date]=r;});
  }catch(e){console.log("getAll err",e);}
  return recs;
}
async function getAllWorkersTodayAtt(today){
  const recs={};
  try{
    const q=await db.collection("attendance").where("date","==",today).get();
    q.forEach(d=>{const r=d.data();recs[r.workerId]=r;});
  }catch(e){console.log("getAllToday err",e);}
  return recs;
}
async function getAllFlagged(){
  const f=[];
  try{
    const q=await db.collection("attendance").where("flag","!=",null).get();
    q.forEach(d=>{const r=d.data();if(r.flag)f.push(r);});
  }catch(e){console.log("flagged err",e);}
  f.sort((a,b)=>b.date.localeCompare(a.date));
  return f;
}

// ============================================================
// HELPERS
// ============================================================
function getToday(){const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
function fmtTime(iso){return iso?new Date(iso).toLocaleTimeString("ar-EG",{hour:"2-digit",minute:"2-digit",hour12:false}):"â€”";}
function fmtDate(s){return new Date(s+"T00:00:00").toLocaleDateString("ar-EG",{weekday:"short",day:"numeric",month:"short"});}
function fmtFull(){return new Date().toLocaleDateString("ar-EG",{weekday:"long",day:"numeric",month:"long",year:"numeric"});}
function calcH(a,b){return(!a||!b)?"â€”":((new Date(b)-new Date(a))/36e5).toFixed(1);}
function mDays(){const n=new Date(),y=n.getFullYear(),m=n.getMonth(),d=[];for(let i=1;i<=new Date(y,m+1,0).getDate();i++)d.push(`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`);return d;}
function mName(){return new Date().toLocaleDateString("ar-EG",{month:"long",year:"numeric"});}
function gid(){return Math.random().toString(36).substr(2,8);}
function esc(s){const d=document.createElement("div");d.textContent=s;return d.innerHTML;}

// ============================================================
// SITE PASSWORD
// ============================================================
function checkSitePass(){
  const v=document.getElementById("site-pass").value;
  if(v===SITE_PASSWORD){showPage("home");}
  else{const e=document.getElementById("site-pass-err");e.textContent="âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";e.style.display="block";document.getElementById("site-pass").value="";}
}

// ============================================================
// PAGE NAV
// ============================================================
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById("page-"+id).classList.add("active");
  if(id==="home")renderHome();
  if(id==="worker-pin")renderWorkerPin();
  if(id==="admin-pin")renderAdminPin();
  if(id==="admin"){aTab="today";adminLoad();}
}

// ============================================================
// HOME
// ============================================================
function renderHome(){
  const c=document.getElementById("home-workers");c.innerHTML="";
  CFG.workers.filter(w=>w.active).forEach(w=>{
    const b=document.createElement("button");b.className="btn-worker";
    b.innerHTML=`<span class="av">${esc(w.name[0])}</span>${esc(w.name)}<span style="margin-right:auto;font-size:.7rem;color:var(--td)">ğŸ”</span>`;
    b.onclick=()=>{curW=w;wAttempts=0;showPage("worker-pin");};
    c.appendChild(b);
  });
}

// ============================================================
// PIN INPUT
// ============================================================
function makePin(cid,eid,cb){
  const c=document.getElementById(cid);c.innerHTML="";const ins=[];
  for(let i=0;i<4;i++){
    const inp=document.createElement("input");inp.type="tel";inp.inputMode="numeric";inp.maxLength=1;inp.className="pin-inp";
    inp.addEventListener("input",function(){if(!/^\d$/.test(this.value)){this.value="";return;}this.classList.add("filled");if(i<3)ins[i+1].focus();if(ins.every(x=>x.value))setTimeout(()=>cb(ins.map(x=>x.value).join("")),150);});
    inp.addEventListener("keydown",function(e){if(e.key==="Backspace"&&!this.value&&i>0){ins[i-1].focus();ins[i-1].value="";ins[i-1].classList.remove("filled");}});
    inp.addEventListener("focus",function(){this.select();});
    ins.push(inp);c.appendChild(inp);
  }
  document.getElementById(eid).style.display="none";
  setTimeout(()=>ins[0].focus(),100);
}
function pinErr(eid,wid,msg){
  document.getElementById(eid).textContent="âš ï¸ "+msg;document.getElementById(eid).style.display="block";
  const w=document.getElementById(wid);w.classList.add("shake");
  setTimeout(()=>{w.classList.remove("shake");w.querySelectorAll("input").forEach(i=>{i.value="";i.classList.remove("filled");});w.querySelector("input").focus();},600);
}

// ============================================================
// WORKER PIN
// ============================================================
function renderWorkerPin(){
  document.getElementById("wp-avatar").textContent=curW.name[0];
  document.getElementById("wp-name").textContent="Ù…Ø±Ø­Ø¨Ø§Ù‹ "+curW.name;
  document.getElementById("wp-pin-label").textContent="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (4 Ø£Ø±Ù‚Ø§Ù…)";
  makePin("wp-pin-wrap","wp-pin-err",function(pin){
    if(pin===curW.pin){showPage("worker");renderWorker();}
    else{wAttempts++;if(wAttempts>=3){pinErr("wp-pin-err","wp-pin-wrap","ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ - ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±");document.getElementById("wp-pin-label").textContent="";}else pinErr("wp-pin-err","wp-pin-wrap",`Ø±Ù…Ø² Ø®Ø§Ø·Ø¦ (${3-wAttempts} Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©)`);}
  });
}

// ============================================================
// WORKER MAIN
// ============================================================
function renderWorker(){
  document.getElementById("w-avatar").textContent=curW.name[0];
  document.getElementById("w-name").textContent=curW.name;
  document.getElementById("w-date").textContent=fmtFull();
  selProj=null;startClock();loadWStatus();
}
function startClock(){if(clockInt)clearInterval(clockInt);function t(){const e=document.getElementById("w-clock");if(e)e.textContent=new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false});}t();clockInt=setInterval(t,1000);}
function workerLogout(){curW=null;if(clockInt)clearInterval(clockInt);showPage("home");}

async function loadWStatus(){
  const c=document.getElementById("w-content");
  c.innerHTML='<div class="loading-spinner">â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  document.getElementById("w-toast").innerHTML="";document.getElementById("w-error").innerHTML="";
  const today=getToday();
  curRec=await getAtt(curW.id,today);
  if(!curRec){
    const projs=CFG.projects.filter(p=>p.active);
    c.innerHTML=`<div style="text-align:center;margin-bottom:16px"><div style="font-size:3rem;margin-bottom:8px" class="pulse">ğŸ‘‹</div><div style="font-size:.85rem;color:var(--td);font-weight:600">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ³Ø¬Ù‘Ù„ ÙˆØµÙˆÙ„Ùƒ</div></div>
    <div style="font-size:.75rem;color:var(--tm);margin-bottom:10px;font-weight:700">ğŸ“ Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…:</div>
    <div class="proj-grid" id="w-projs"></div>
    <button class="btn-big btn-disabled" id="w-ci-btn" onclick="doCI()" disabled>â¬†ï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹</button>`;
    const pg=document.getElementById("w-projs");
    projs.forEach(p=>{const b=document.createElement("button");b.className="proj-btn";b.textContent=p.name;b.onclick=()=>{selProj=p;pg.querySelectorAll(".proj-btn").forEach(x=>x.classList.remove("sel"));b.classList.add("sel");b.textContent="âœ… "+p.name;const btn=document.getElementById("w-ci-btn");btn.disabled=false;btn.className="btn-big btn-checkin";btn.textContent="âœ… ØªØ³Ø¬ÙŠÙ„ ÙˆØµÙˆÙ„";};pg.appendChild(b);});
  }else if(curRec.checkIn&&!curRec.checkOut){
    c.innerHTML=`<div class="info-row green"><span style="color:var(--tm);font-size:.85rem;font-weight:600">â° ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„</span><span style="color:var(--g);font-size:1.15rem;font-weight:800;font-family:monospace">${fmtTime(curRec.checkIn)}</span></div>
    <div class="info-row gold" style="justify-content:center"><span style="font-size:.75rem;color:var(--td)">ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: </span><span style="font-size:.88rem;color:var(--accent);font-weight:700">${esc(curRec.projectName||"â€”")}</span></div>
    ${curRec.checkInLoc?`<div style="font-size:.72rem;color:var(--td);margin:12px 0;text-align:center">ğŸ“ ${curRec.checkInLoc.lat.toFixed(5)}, ${curRec.checkInLoc.lng.toFixed(5)}</div>`:""}
    <button class="btn-big btn-checkout" onclick="doCO()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ù…ØºØ§Ø¯Ø±Ø©</button>`;
  }else{
    const r=curRec;
    c.innerHTML=`<div style="text-align:center;margin-bottom:16px"><div style="font-size:2.8rem;margin-bottom:8px">âœ…</div><div style="color:var(--g);font-weight:800;font-size:1.05rem">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</div></div>
    <div style="text-align:center;margin-bottom:16px"><span style="background:rgba(212,168,83,.1);border:1px solid rgba(212,168,83,.25);border-radius:20px;padding:4px 14px;font-size:.78rem;color:var(--accent);font-weight:700">ğŸ“ ${esc(r.projectName||"â€”")}</span></div>
    <div class="stats-3">
      <div class="stat-box" style="background:rgba(39,201,110,.07);border:1px solid rgba(39,201,110,.2)"><div class="stat-lbl">ÙˆØµÙˆÙ„</div><div class="stat-val" style="color:var(--g)">${fmtTime(r.checkIn)}</div></div>
      <div class="stat-box" style="background:rgba(231,76,60,.07);border:1px solid rgba(231,76,60,.2)"><div class="stat-lbl">Ù…ØºØ§Ø¯Ø±Ø©</div><div class="stat-val" style="color:var(--r)">${fmtTime(r.checkOut)}</div></div>
      <div class="stat-box" style="background:rgba(212,168,83,.07);border:1px solid rgba(212,168,83,.2)"><div class="stat-lbl">Ø³Ø§Ø¹Ø§Øª</div><div class="stat-val" style="color:var(--accent)">${calcH(r.checkIn,r.checkOut)}</div></div>
    </div>
    ${r.checkInLoc?`<div style="margin-top:14px;padding:10px 14px;background:rgba(20,36,58,.5);border-radius:10px;font-size:.7rem;color:var(--td)">ğŸ“ ÙˆØµÙˆÙ„: <a href="https://maps.google.com/?q=${r.checkInLoc.lat},${r.checkInLoc.lng}" target="_blank" style="color:var(--blue)">Ø®Ø±ÙŠØ·Ø©</a>${r.checkOutLoc?` Â· ğŸ“ Ù…ØºØ§Ø¯Ø±Ø©: <a href="https://maps.google.com/?q=${r.checkOutLoc.lat},${r.checkOutLoc.lng}" target="_blank" style="color:var(--blue)">Ø®Ø±ÙŠØ·Ø©</a>`:""}</div>`:""}`;
  }
}

function wToast(m){document.getElementById("w-toast").innerHTML=`<div class="toast">${m}</div>`;setTimeout(()=>{document.getElementById("w-toast").innerHTML="";},3000);}
function wErr(m){document.getElementById("w-error").innerHTML=`<div class="toast toast-err">âš ï¸ ${m}</div>`;}

function getLoc(){return new Promise((res,rej)=>{if(!navigator.geolocation)return rej("GPS ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude,acc:Math.round(p.coords.accuracy)}),()=>rej("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS"),{enableHighAccuracy:true,timeout:15000,maximumAge:0});});}

async function doCI(){
  if(!selProj){wErr("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹");return;}
  const btn=document.getElementById("w-ci-btn");btn.disabled=true;btn.textContent="â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";btn.className="btn-big btn-disabled";
  document.getElementById("w-error").innerHTML="";
  try{
    const loc=await getLoc();const now=new Date().toISOString();const today=getToday();
    const rec={workerId:curW.id,workerName:curW.name,date:today,projectId:selProj.id,projectName:selProj.name,checkIn:now,checkInLoc:loc,checkOut:null,checkOutLoc:null,flag:null};
    await setAtt(curW.id,today,rec);curRec=rec;wToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");loadWStatus();
  }catch(e){wErr(typeof e==="string"?e:"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");btn.disabled=false;btn.className="btn-big btn-checkin";btn.textContent="âœ… ØªØ³Ø¬ÙŠÙ„ ÙˆØµÙˆÙ„";}
}

async function doCO(){
  const btn=document.querySelector(".btn-checkout");if(btn){btn.disabled=true;btn.textContent="â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";}
  document.getElementById("w-error").innerHTML="";
  try{
    const loc=await getLoc();const now=new Date().toISOString();
    const rec={...curRec,checkOut:now,checkOutLoc:loc};
    await setAtt(curW.id,getToday(),rec);curRec=rec;wToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");loadWStatus();
  }catch(e){wErr(typeof e==="string"?e:"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");if(btn){btn.disabled=false;btn.textContent="ğŸšª ØªØ³Ø¬ÙŠÙ„ Ù…ØºØ§Ø¯Ø±Ø©";}}
}

// ============================================================
// ADMIN
// ============================================================
function renderAdminPin(){
  makePin("ap-pin-wrap","ap-pin-err",function(pin){
    if(pin===CFG.adminPin)showPage("admin");
    else pinErr("ap-pin-err","ap-pin-wrap","Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ± ØºÙŠØ± ØµØ­ÙŠØ­");
  });
}

async function adminLoad(){
  document.getElementById("admin-sub").textContent=CFG.companyName;
  renderATabs();
  document.getElementById("admin-content").innerHTML='<div class="loading-spinner">â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  await renderASummary();
  await renderAContent();
}

async function renderASummary(){
  const today=getToday();const aw=CFG.workers.filter(w=>w.active);
  const todayRecs=await getAllWorkersTodayAtt(today);
  let p=0,a=0,act=0;
  aw.forEach(w=>{const r=todayRecs[w.id];if(r?.checkOut)p++;else if(r?.checkIn){p++;act++;}else a++;});
  document.getElementById("admin-summary").innerHTML=[
    {i:"ğŸ‘¥",l:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ",v:aw.length,c:"var(--tm)"},{i:"âœ…",l:"Ø­Ø§Ø¶Ø±",v:p,c:"var(--g)"},{i:"ğŸ”µ",l:"ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹",v:act,c:"var(--o)"},{i:"âŒ",l:"ØºØ§Ø¦Ø¨",v:a,c:"var(--r)"},
  ].map(x=>`<div class="sum-card"><div style="font-size:1.1rem">${x.i}</div><div class="sum-val" style="color:${x.c}">${x.v}</div><div class="sum-lbl">${x.l}</div></div>`).join("");
  window._todayRecs=todayRecs;
}

function renderATabs(){
  const tabs=[{id:"today",i:"ğŸ“‹",l:"Ø§Ù„ÙŠÙˆÙ…"},{id:"monthly",i:"ğŸ“…",l:"Ø´Ù‡Ø±ÙŠ"},{id:"manage",i:"âš™ï¸",l:"Ø¥Ø¯Ø§Ø±Ø©"},{id:"archive",i:"ğŸ—„ï¸",l:"Ø£Ø±Ø´ÙŠÙ"}];
  document.getElementById("admin-tabs").innerHTML=tabs.map(t=>`<button class="tab-btn ${aTab===t.id?"active":""}" onclick="aTab='${t.id}';renderATabs();renderAContent();">${t.i} ${t.l}</button>`).join("");
}

async function renderAContent(){
  const c=document.getElementById("admin-content");
  c.innerHTML='<div class="loading-spinner">â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  if(aTab==="today")await rToday(c);
  else if(aTab==="monthly")await rMonthly(c);
  else if(aTab==="manage")rManage(c);
  else if(aTab==="archive")await rArchive(c);
}

async function rToday(c){
  const today=getToday();const aw=CFG.workers.filter(w=>w.active);
  const recs=window._todayRecs||await getAllWorkersTodayAtt(today);
  let rows="";
  aw.forEach(w=>{
    const r=recs[w.id];const st=r?.checkOut?{t:"Ø£Ù†Ù‡Ù‰",c:"var(--g)"}:r?.checkIn?{t:"Ù…ÙˆØ¬ÙˆØ¯",c:"var(--o)"}:{t:"ØºØ§Ø¦Ø¨",c:"var(--r)"};
    rows+=`<tr><td style="font-weight:700">${esc(w.name)}</td><td style="font-size:.78rem;color:var(--accent);font-weight:600">${esc(r?.projectName||"â€”")}</td><td><span class="badge" style="background:${st.c}18;color:${st.c}">${st.t}</span></td><td class="mono" style="color:var(--tm)">${fmtTime(r?.checkIn)}</td><td class="mono" style="color:var(--tm)">${fmtTime(r?.checkOut)}</td><td style="color:var(--accent);font-weight:700">${calcH(r?.checkIn,r?.checkOut)}</td><td>${r?.checkInLoc?`<a href="https://maps.google.com/?q=${r.checkInLoc.lat},${r.checkInLoc.lng}" target="_blank" style="color:var(--blue);font-size:.75rem">ğŸ“</a>`:"â€”"}</td></tr>`;
  });
  c.innerHTML=`<div class="tbl-wrap"><div class="tbl-head"><h3>ğŸ“‹ ${new Date().toLocaleDateString("ar-EG",{weekday:"long",day:"numeric",month:"long"})}</h3></div><div style="overflow-x:auto"><table><thead><tr>${["Ø§Ù„Ø¹Ø§Ù…Ù„","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","Ø§Ù„Ø­Ø§Ù„Ø©","ÙˆØµÙˆÙ„","Ù…ØºØ§Ø¯Ø±Ø©","Ø³Ø§Ø¹Ø§Øª","ğŸ“"].map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rows}</tbody></table></div></div>`;
}

async function rMonthly(c){
  const days=mDays();const today=getToday();
  const wtabs=CFG.workers.map(w=>`<button class="wtab ${mWorker===w.id?"active":""}" onclick="mWorker='${w.id}';renderAContent();">${esc(w.name)}</button>`).join("");
  let body="";
  if(mWorker){
    const recs=await getAllAtt(mWorker);
    let tD=0,tH=0;const pc={};let rows="";
    days.forEach(day=>{
      const r=recs[day];const isT=day===today;const isF=day>today;
      if(r?.checkIn)tD++;
      if(r?.checkIn&&r?.checkOut)tH+=(new Date(r.checkOut)-new Date(r.checkIn))/36e5;
      if(r?.projectName)pc[r.projectName]=(pc[r.projectName]||0)+1;
      rows+=`<tr style="opacity:${isF?.25:1};${isT?"background:rgba(212,168,83,.05)":""}"><td class="mono" style="font-size:.75rem;color:${isT?"var(--accent)":"var(--tm)"};font-weight:${isT?800:500}">${day}</td><td style="font-size:.75rem;color:var(--tm)">${fmtDate(day)}</td><td style="font-size:.73rem;color:var(--accent);font-weight:600">${esc(r?.projectName||"â€”")}</td><td class="mono" style="color:${r?.checkIn?"var(--g)":"#2a3d52"};font-size:.75rem">${fmtTime(r?.checkIn)}</td><td class="mono" style="color:${r?.checkOut?"var(--r)":"#2a3d52"};font-size:.75rem">${fmtTime(r?.checkOut)}</td><td style="color:var(--accent);font-weight:700;font-size:.75rem">${calcH(r?.checkIn,r?.checkOut)}</td><td>${r?.checkInLoc?`<a href="https://maps.google.com/?q=${r.checkInLoc.lat},${r.checkInLoc.lng}" target="_blank" style="color:var(--blue)">ğŸ“</a>`:`<span style="color:#2a3d52">â€”</span>`}</td><td style="font-size:.68rem;color:${r?.flag?"var(--o)":"var(--td)"}">${r?.flag?"ğŸ·ï¸ "+esc(r.flag):"â€”"}</td><td>${r&&!isF?`<button class="btn-sm" style="background:rgba(240,160,48,.12);color:var(--o)" onclick="openFlag('${mWorker}','${day}')">ğŸ·ï¸</button> <button class="btn-sm" style="background:rgba(231,76,60,.12);color:var(--r)" onclick="delRec('${mWorker}','${day}')">ğŸ—‘ï¸</button>`:""}</td></tr>`;
    });
    const pt=Object.entries(pc).map(([n,c])=>`<span style="background:rgba(212,168,83,.08);border:1px solid rgba(212,168,83,.2);border-radius:16px;padding:3px 10px;font-size:.68rem;color:var(--accent)">${esc(n)}: ${c} ÙŠÙˆÙ…</span>`).join(" ");
    body=`<div style="overflow-x:auto"><table><thead><tr>${["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„ÙŠÙˆÙ…","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","ÙˆØµÙˆÙ„","Ù…ØºØ§Ø¯Ø±Ø©","Ø³Ø§Ø¹Ø§Øª","ğŸ“","Ù…Ù„Ø§Ø­Ø¸Ø©","Ø¥Ø¬Ø±Ø§Ø¡"].map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rows}</tbody></table></div>
    <div style="display:flex;justify-content:center;gap:28px;padding:14px 18px;background:rgba(212,168,83,.04);border-top:1px solid var(--border)">
      <div style="text-align:center"><div style="font-size:1.2rem;font-weight:900;color:var(--g)">${tD}</div><div style="font-size:.63rem;color:var(--td)">Ø£ÙŠØ§Ù…</div></div>
      <div style="text-align:center"><div style="font-size:1.2rem;font-weight:900;color:var(--accent)">${tH.toFixed(1)}</div><div style="font-size:.63rem;color:var(--td)">Ø³Ø§Ø¹Ø§Øª</div></div>
      <div style="text-align:center"><div style="font-size:1.2rem;font-weight:900;color:var(--tm)">${tD>0?(tH/tD).toFixed(1):"0"}</div><div style="font-size:.63rem;color:var(--td)">Ù…Ø¹Ø¯Ù„</div></div>
    </div>${pt?`<div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;padding:10px 18px">${pt}</div>`:""}`;
  }
  c.innerHTML=`<div class="tbl-wrap"><div class="tbl-head"><h3>ğŸ“… ${mName()}</h3></div><div class="wtabs">${wtabs}</div>${body}</div>`;
}

function rManage(c){
  let wR=CFG.workers.map(w=>`<div class="manage-row" style="opacity:${w.active?1:.5}"><span style="flex:1;font-weight:600;font-size:.88rem;${w.active?"":"text-decoration:line-through"}">${esc(w.name)}</span><span style="color:var(--accent);font-family:monospace;font-weight:800;font-size:.85rem;direction:ltr">${w.pin}</span><button class="btn-sm" style="background:rgba(212,168,83,.12);color:var(--accent)" onclick="openEditPin('${w.id}')">âœï¸ PIN</button><button class="btn-sm" style="background:${w.active?"rgba(231,76,60,.12)":"rgba(39,201,110,.12)"};color:${w.active?"var(--r)":"var(--g)"}" onclick="togW('${w.id}')">${w.active?"ØªØ¹Ø·ÙŠÙ„":"ØªÙØ¹ÙŠÙ„"}</button></div>`).join("");
  let pT=CFG.projects.map(p=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(15,25,42,.6);border-radius:10px;opacity:${p.active?1:.5}"><span style="font-weight:600;font-size:.82rem;${p.active?"":"text-decoration:line-through"}">${esc(p.name)}</span><button class="btn-sm" style="background:${p.active?"rgba(231,76,60,.12)":"rgba(39,201,110,.12)"};color:${p.active?"var(--r)":"var(--g)"}" onclick="togP('${p.id}')">${p.active?"âœ•":"âœ“"}</button></div>`).join("");
  c.innerHTML=`
  <div class="manage-card"><h3>ğŸ‘· Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„</h3>${wR}<div style="display:flex;gap:8px;margin-top:16px"><input class="manage-input" id="nwn" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„" style="flex:1"><input class="manage-input" id="nwp" placeholder="PIN" maxlength="4" style="width:80px;direction:ltr;text-align:center"><button class="btn-add" onclick="addW()">+ Ø¥Ø¶Ø§ÙØ©</button></div></div>
  <div class="manage-card"><h3>ğŸ—ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3><div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">${pT}</div><div style="display:flex;gap:8px"><input class="manage-input" id="npn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="flex:1"><button class="btn-add" onclick="addP()">+ Ø¥Ø¶Ø§ÙØ©</button></div></div>
  <div class="manage-card"><h3>ğŸ” ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±</h3><div style="display:flex;gap:8px;align-items:center"><span style="color:var(--tm);font-size:.85rem">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ:</span><span style="color:var(--accent);font-family:monospace;font-weight:800;font-size:1rem;direction:ltr">${CFG.adminPin}</span><button class="btn-sm" style="background:rgba(212,168,83,.12);color:var(--accent);padding:6px 14px;font-size:.78rem" onclick="openEditAdmin()">âœï¸ ØªØºÙŠÙŠØ±</button></div></div>
  <div class="manage-card"><h3>ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3><p style="color:var(--td);font-size:.78rem;margin-bottom:10px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong style="color:var(--accent)">${SITE_PASSWORD}</strong></p><p style="color:var(--td);font-size:.72rem">Ù„ØªØºÙŠÙŠØ±Ù‡Ø§: Ø¹Ø¯Ù‘Ù„ Ù‚ÙŠÙ…Ø© SITE_PASSWORD ÙÙŠ ÙƒÙˆØ¯ HTML</p></div>
  <div class="manage-card"><h3>ğŸ§ª Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</h3><p style="color:var(--td);font-size:.78rem;margin-bottom:14px">Ø¥Ø¶Ø§ÙØ© 5 Ø£ÙŠØ§Ù… ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ø£ÙˆÙ„ Ø¹Ø§Ù…Ù„</p><button style="padding:10px 20px;background:rgba(212,168,83,.15);border:1px solid rgba(212,168,83,.3);border-radius:10px;color:var(--accent);font-weight:700" onclick="genDemo()">ğŸ§ª Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button></div>`;
}

async function rArchive(c){
  const f=await getAllFlagged();
  if(!f.length){c.innerHTML=`<div class="tbl-wrap"><div class="tbl-head"><h3>ğŸ—„ï¸ Ø£Ø±Ø´ÙŠÙ</h3></div><div style="padding:30px;text-align:center;color:var(--td)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙØ¹Ù„Ù‘Ù…Ø©</div></div>`;return;}
  let rows=f.map(r=>`<tr><td class="mono" style="font-size:.75rem;color:var(--tm)">${r.date}</td><td style="font-weight:700;font-size:.82rem">${esc(r.workerName)}</td><td style="font-size:.75rem;color:var(--accent);font-weight:600">${esc(r.projectName||"â€”")}</td><td class="mono" style="color:var(--tm);font-size:.75rem">${fmtTime(r.checkIn)}</td><td class="mono" style="color:var(--tm);font-size:.75rem">${fmtTime(r.checkOut)}</td><td style="color:var(--accent);font-weight:700;font-size:.75rem">${calcH(r.checkIn,r.checkOut)}</td><td style="font-size:.75rem;color:var(--o);font-weight:600">ğŸ·ï¸ ${esc(r.flag)}</td><td><button class="btn-sm" style="background:rgba(231,76,60,.12);color:var(--r)" onclick="delRec('${r.workerId}','${r.date}')">ğŸ—‘ï¸</button></td></tr>`).join("");
  c.innerHTML=`<div class="tbl-wrap"><div class="tbl-head"><h3>ğŸ—„ï¸ Ø£Ø±Ø´ÙŠÙ</h3></div><div style="overflow-x:auto"><table><thead><tr>${["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ø¹Ø§Ù…Ù„","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","ÙˆØµÙˆÙ„","Ù…ØºØ§Ø¯Ø±Ø©","Ø³Ø§Ø¹Ø§Øª","Ù…Ù„Ø§Ø­Ø¸Ø©","Ø¥Ø¬Ø±Ø§Ø¡"].map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rows}</tbody></table></div></div>`;
}

// ============================================================
// ADMIN ACTIONS
// ============================================================
async function addW(){const n=document.getElementById("nwn").value.trim(),p=document.getElementById("nwp").value.trim();if(!n||!p||p.length!==4||!/^\d{4}$/.test(p))return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ùˆ PIN (4 Ø£Ø±Ù‚Ø§Ù…)");CFG.workers.push({id:gid(),name:n,pin:p,active:true});await saveCfg();renderAContent();}
async function togW(id){CFG.workers=CFG.workers.map(w=>w.id===id?{...w,active:!w.active}:w);await saveCfg();await renderASummary();renderAContent();}
async function addP(){const n=document.getElementById("npn").value.trim();if(!n)return;CFG.projects.push({id:gid(),name:n,active:true});await saveCfg();renderAContent();}
async function togP(id){CFG.projects=CFG.projects.map(p=>p.id===id?{...p,active:!p.active}:p);await saveCfg();renderAContent();}

async function delRec(wid,date){if(!confirm("Ø­Ø°Ù Ø³Ø¬Ù„ "+date+"ØŸ"))return;await delAtt(wid,date);await renderAContent();}

async function genDemo(){
  const aw=CFG.workers.filter(w=>w.active);if(!aw.length)return;
  const w=aw[0];const projs=CFG.projects.filter(p=>p.active);
  for(let i=1;i<=5;i++){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const p=projs[i%projs.length]||projs[0];
    const ci=new Date(d);ci.setHours(7+Math.floor(Math.random()*2),Math.floor(Math.random()*60));
    const co=new Date(ci);co.setHours(ci.getHours()+8+Math.floor(Math.random()*2));
    await setAtt(w.id,ds,{workerId:w.id,workerName:w.name,date:ds,projectId:p.id,projectName:p.name,checkIn:ci.toISOString(),checkInLoc:{lat:32.08+Math.random()*.01,lng:34.78+Math.random()*.01,acc:10},checkOut:co.toISOString(),checkOutLoc:{lat:32.08+Math.random()*.01,lng:34.78+Math.random()*.01,acc:10},flag:"ØªØ¬Ø±ÙŠØ¨ÙŠ"});
  }
  alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ 5 Ø³Ø¬Ù„Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù€ "+w.name);adminLoad();
}

// ============================================================
// MODALS
// ============================================================
function closeModal(){document.getElementById("modal").style.display="none";}

function openFlag(wid,date){
  const tags=["ØªØ¬Ø±ÙŠØ¨ÙŠ","Ø¨Ø§Ù„Ø®Ø·Ø£","Ø¥Ø¬Ø§Ø²Ø©","ØªØ£Ø®ÙŠØ±","Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠ"];
  document.getElementById("modal-content").innerHTML=`
    <h3>ğŸ·ï¸ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø³Ø¬Ù„</h3>
    <div class="tag-btns">${tags.map(t=>`<button class="tag-btn" onclick="document.getElementById('fi').value='${t}';this.parentNode.querySelectorAll('.tag-btn').forEach(b=>b.classList.remove('sel'));this.classList.add('sel')">${t}</button>`).join("")}</div>
    <input class="manage-input" id="fi" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø©..." style="margin-bottom:14px">
    <div style="display:flex;gap:8px">
      <button style="flex:1;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accentG));border:none;border-radius:10px;color:#0b1929;font-weight:700;cursor:pointer" onclick="saveFlag('${wid}','${date}')">ğŸ’¾ Ø­ÙØ¸</button>
      <button style="padding:12px;background:rgba(231,76,60,.15);border:none;border-radius:10px;color:var(--r);font-weight:700;cursor:pointer" onclick="rmFlag('${wid}','${date}')">Ø¥Ø²Ø§Ù„Ø©</button>
    </div>`;
  document.getElementById("modal").style.display="flex";
}
async function saveFlag(wid,date){const n=document.getElementById("fi").value.trim();const r=await getAtt(wid,date);if(!r)return;r.flag=n;await setAtt(wid,date,r);closeModal();renderAContent();}
async function rmFlag(wid,date){const r=await getAtt(wid,date);if(!r)return;r.flag=null;await setAtt(wid,date,r);closeModal();renderAContent();}

function openEditPin(wid){
  const w=CFG.workers.find(x=>x.id===wid);if(!w)return;
  document.getElementById("modal-content").innerHTML=`
    <h3>âœï¸ ØªØºÙŠÙŠØ± PIN Ù„Ù€ ${esc(w.name)}</h3>
    <p style="color:var(--td);font-size:.8rem;margin-bottom:12px">PIN Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong style="color:var(--accent);font-family:monospace">${w.pin}</strong></p>
    <input class="manage-input" id="epi" placeholder="PIN Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù…)" maxlength="4" style="direction:ltr;text-align:center;font-size:1.2rem;font-weight:800;margin-bottom:14px;letter-spacing:8px" type="tel" inputmode="numeric">
    <button style="width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accentG));border:none;border-radius:10px;color:#0b1929;font-weight:700;cursor:pointer;font-size:1rem" onclick="saveWPin('${wid}')">ğŸ’¾ Ø­ÙØ¸</button>`;
  document.getElementById("modal").style.display="flex";
  setTimeout(()=>document.getElementById("epi").focus(),100);
}
async function saveWPin(wid){const p=document.getElementById("epi").value.trim();if(!p||p.length!==4||!/^\d{4}$/.test(p))return alert("Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù…");CFG.workers=CFG.workers.map(w=>w.id===wid?{...w,pin:p}:w);await saveCfg();closeModal();renderAContent();}

function openEditAdmin(){
  document.getElementById("modal-content").innerHTML=`
    <h3>ğŸ” ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
    <p style="color:var(--td);font-size:.8rem;margin-bottom:12px">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong style="color:var(--accent);font-family:monospace">${CFG.adminPin}</strong></p>
    <input class="manage-input" id="eai" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù…)" maxlength="4" style="direction:ltr;text-align:center;font-size:1.2rem;font-weight:800;margin-bottom:14px;letter-spacing:8px" type="tel" inputmode="numeric">
    <button style="width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accentG));border:none;border-radius:10px;color:#0b1929;font-weight:700;cursor:pointer;font-size:1rem" onclick="saveAPin()">ğŸ’¾ Ø­ÙØ¸</button>`;
  document.getElementById("modal").style.display="flex";
  setTimeout(()=>document.getElementById("eai").focus(),100);
}
async function saveAPin(){const p=document.getElementById("eai").value.trim();if(!p||p.length!==4||!/^\d{4}$/.test(p))return alert("Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù…");CFG.adminPin=p;await saveCfg();closeModal();renderAContent();}

// ============================================================
// INIT
// ============================================================
async function init(){
  CFG=await loadCfg();
  if(!CFG){CFG=JSON.parse(JSON.stringify(DEF));await saveCfg();}
  // Check if already authenticated this session
  if(sessionStorage.getItem("mashour_auth")==="1")showPage("home");
}
// Override checkSitePass to save session
const _origCheck=checkSitePass;
window.checkSitePass=function(){
  const v=document.getElementById("site-pass").value;
  if(v===SITE_PASSWORD){sessionStorage.setItem("mashour_auth","1");showPage("home");}
  else{const e=document.getElementById("site-pass-err");e.textContent="âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";e.style.display="block";document.getElementById("site-pass").value="";}
};
init();
</script>
</body>
</html>
